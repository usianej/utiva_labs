# Azure App Service and SQL DB - Lab (AzureCLI)

You can follow the microsoft guide 

https://learn.microsoft.com/en-us/azure/app-service/tutorial-dotnetcore-sqldb-app?tabs=azure-cli%2Cazure-cli-deploy%2Cdeploy-instructions-azcli%2Cazure-cli-logs%2Cvisual-studio-code-resources#code-try-7

Login to you e Azure Account 

  az login

> Use 'az account list-locations --output table' to list available locations close to you

> Create a resource group

  az group create --location eastus --name msdocs-core-sql

Change *jeau24* to any three characters to form a unique name

    az appservice plan create \
      --name msdocs-core-sql-plan-jeau24 \
      --resource-group msdocs-core-sql \
      --sku F1

- create the App Service web app using the az webapp create command

  az webapp create \
      --name <your-app-service-name> \
      --runtime "DOTNET|6.0" \
      --plan <your-app-service-plan-name> \
      --resource-group msdocs-core-sql

Example

    az webapp create \
        --name sqlapp0123 \
        --runtime "DOTNET|6.0" \
        --plan msdocs-core-sql-plan-jeau24 \
        --resource-group msdocs-core-sql

- create the Azure SQL Database that manages the data in our app

  az sql server create \
    --location eastus \
    --resource-group msdocs-core-sql \
    --name <server-name> \
    --admin-user <db-username> \
    --admin-password <db-password>

Example:

    az sql server create \
        --location eastus \
        --resource-group msdocs-core-sql \
        --name sv20sqlapp02 \
        --admin-user admjeff \
        --admin-password Plunder34

- Create Database

  az sql db create \
    --resource-group msdocs-core-sql \
    --server <server-name> \
    --name coreDb

Example:

    az sql db create \
        --resource-group msdocs-core-sql \
        --server sv20sqlapp02 \
        --name coreDb

- Connect the App to the Database

    az webapp connection create sql \
        --resource-group msdocs-core-sql \
        --name <your-app-service-name> \
        --target-resource-group msdocs-core-sql \
        --server <server-name> \
        --database coreDB \
        --query configurations

Example:

    az webapp connection create sql \
        --resource-group msdocs-core-sql \
        --name sqlapp0123 \
        --target-resource-group msdocs-core-sql \
        --server sv20sqlapp02 \
        --database coreDB \
        --query configurations

### Generate the Database Schema

This is a very important section 

- Create firewall exception

  az sql server firewall-rule create --resource-group msdocs-core-sql --server <yoursqlserver> --name LocalAccess --start-ip-address <your-ip> --end-ip-address <your-ip>

Example:

    az sql server firewall-rule create --resource-group msdocs-core-sql --server sv20sqlapp02 --name LocalAccess --start-ip-address 10.32.4.11 --end-ip-address 10.32.4.11

> Next, update the name of the connection string in appsettings.json file to match the AZURE_SQL_CONNECTION name generated by the service connector. When the app is deployed to Azure, the localdb connection string value will be overridden by the connection string stored in Azure.

> service connector can be found in appservice(webbapp) > settiings 

>edit **appsettings.json** 

  "AZURE_SQL_CONNECTIONSTRING": {
    "Data Source=sv20sqlapp02.database.windows.net,1433;Initial Catalog=coreDB;User ID=admjeff;Password=Plunder34"
  }

> edit **Startup.cs** *change to AZURE_SQL_CONNECTIONSTRING*

services.AddDbContext<MyDatabaseContext>(options =>
        options.UseSqlServer(Configuration.GetConnectionString("AZURE_SQL_CONNECTIONSTRING")));


> update the Startup.cs file the sample project by updating the existing connection string name MyDbConnection to AZURE_SQL_CONNECTIONSTRING. This change configures the DbContext to use the correct connection string in Azure and locally from the appsettings.json file.

> Install nessesary cli tools

  cd <sample-root>\DotNetCoreSqlDb
  dotnet tool install -g dotnet-ef
  dotnet ef migrations add InitialCreate

  dotnet ef database update --connection "<your-azure-sql-connection-string>"

Example:

    dotnet ef database update --connection "Server=tcp:sv20sqlapp02.database.windows.net,1433;Initial Catalog=coreDb;Persist Security Info=False;User ID=admjeff;Password=Plunder34;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"

> Configure the deployment source for your web app to be local Git using the az webapp deployment source command

    az webapp deployment source config-local-git \
        --name <your-app-name> \
        --resource-group msdocs-core-sql

Example:

    az webapp deployment source config-local-git \
        --name sqlapp0123 \
        --resource-group msdocs-core-sql

> Retrieve the deployment credentials for your application. These will be needed for Git to authenticate to Azure when you push code to Azure in a later step.

    az webapp deployment list-publishing-credentials \
            --name <your-app-name> \
            --resource-group msdocs-core-sql \
            --query "{Username:publishingUserName, Password:publishingPassword}"

Example:

    az webapp deployment list-publishing-credentials \
            --name sqlapp0123 \
            --resource-group msdocs-core-sql \
            --query "{Username:publishingUserName, Password:publishingPassword}"

**Output** 

save the output somewere safe

e.g:

{
  "Password": "RaKakgi0xMaX6WtxHdwMftihR4ztGKMBNczGXwFntH15L7owagWlKaNeghJ7",
  "Username": "$sqlapp0123"
}

> add an Azure origin to our local Git repo using the App Service Git deployment URL from the step where we created our App Service.

change the sqlapp0123.git to yours

git remote add azure https://sqlapp0123.scm.azurewebsites.net/sqlapp0123.git
git add .
git commit -m "Updating the modified appsettings.json and Startup.cs files"
git push azure main:master

### Monitor

    az webapp log tail \
        --name $APP_SERVICE_NAME \
        --resource-group $RESOURCE_GROUP_NAME

Example:

    az webapp log tail \
        --name sqlapp0123 \
        --resource-group msdocs-core-sql
